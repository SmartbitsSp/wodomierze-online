{% extends 'admin_panel.html' %}

{% block user %}

    <h2>Przegląd użytkownika</h2>

    <!-- Informacje o użytkowniku -->
    <div class="user-info">
        <h4>Email: {{ user.email }}</h4>
        <h5>Notatki o użytkowniku</h5>
    <div id="notes-display-field">
    {% if user.notes and user.notes.strip() != '' %}
        {{ user.notes }}
    {% else %}
        <p>Brak notatek.</p>
    {% endif %}
        <button id="edit-notes-button" class="btn btn-secondary">Edytuj notatki</button>
    <form method="POST" id="notes-edit-field" style="display: none;">
        {{ user_notes_form.hidden_tag() }}
        <div class="form-group">
            {{ user_notes_form.notes.label(class="form-label") }}
    {{ user_notes_form.notes(class="form-control", value=user.notes) }}
        </div>
        <button type="submit" class="btn btn-primary">Zapisz notatki</button>
    </form>
    </div>
<br>
    <!-- Lista przypisanych liczników -->
    <div class="assigned-meters">
        <h3>Przypisane liczniki</h3>
    <input type="text" id="search-meter-input-assigned" placeholder="Numer radiowy">
        <ul class="meter-list limited-list" style="max-height: 200px; max-width: 400px" id="meter-list-assigned">
            {% for meter in user.meters %}
                <li class="meter-item" style="width: 300px">{{ meter.radio_number }} - <a href="{{ url_for('main_routes.meter_details', meter_id=meter.id) }}">Szczegóły</a> | <button class="btn btn-danger" onclick="confirmDelete('{{ meter.id }}')">Usuń</button></li>
            {% endfor %}
        </ul>
    </div>

    <!-- Formularz dodawania licznika -->
 <h3>Wolne liczniki</h3>

    {% if successfully_assigned %}
    <div class="alert alert-success" role="alert">
        Przypisano następujące liczniki: {{ successfully_assigned|join(', ') }}
    </div>
{% endif %}

    {% if not_assigned %}
<div class="alert alert-warning">
    <h4>Nieudane przypisania:</h4>
    <ul>
        {% for meter_number, reason in not_assigned %}
        <li>{{ meter_number }} - {{ reason }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if not_assigned %}
    <div class="alert alert-danger" role="alert">
        Nie udało się przypisać lub liczniki są już przypisane: {{ not_assigned|join(', ') }}
    </div>
{% endif %}
    <h5>Dodaj liczniki (oddzielone przecinkami, spacjami lub enterami)</h5>
<form method="POST" action="{{ url_for('main_routes.assign_meters_to_user', user_id=user.id) }}">
    {{ user_form.hidden_tag() }}
    <div class="form-group">
        <textarea name="meter_list" class="form-control" rows="4" placeholder="Wprowadź numery radiowe liczników"></textarea>
    </div>
    <button type="submit" class="btn btn-primary">Przypisz liczniki</button>
</form>
<br />

<input type="text" id="search-meter-input-2" placeholder="Numer radiowy">
<ul class="user-list limited-list" style="width: 250px" id="meter-list-2">
    {% for meter in unassigned_meters %}
        <li class="meter-item" style="width: 150px">{{ meter.radio_number }} <a href="{{ url_for('main_routes.assign_meter', user_id=user.id, meter_id=meter.id) }}">Assign</a></li>
    {% endfor %}
</ul>

    <button class="btn btn-danger" onclick="showPasswordInput()">Usuń Użytkownika</button>
    <form id="deleteUserForm" method="POST" action="{{ url_for('main_routes.delete_user', user_id=user.id) }}" style="display: none;">
        <div class="form-group">
            <label for="admin_password">Administrator Password</label>
            <input type="password" name="admin_password" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-danger" onclick="return confirm('Czy na pewno chcesz usunąć tego użytkownika?')">Usuń Użytkownika</button>
    </form>
    <br />
     <!-- Przycisk dezaktywacji użytkownika -->
    {% if user.is_active %}
        <form method="POST" action="{{ url_for('main_routes.deactivate_user', user_id=user.id) }}">
            <button type="submit" class="btn btn-warning" onclick="return confirm('Czy na pewno chcesz dezaktywować to konto?')">Dezaktywuj Konto</button>
        </form>
    {% else %}
        <form method="POST" action="{{ url_for('main_routes.deactivate_user', user_id=user.id) }}">
            <button type="submit" class="btn btn-success" onclick="return confirm('Czy na pewno chcesz aktywować to konto?')">Aktywuj Konto</button>
        </form>
    {% endif %}
    </div>
    <script>
        function showPasswordInput() {
            const deleteUserForm = document.getElementById('deleteUserForm');
            deleteUserForm.style.display = 'block';
        }
    </script>
    <script>
    const searchMeterInputAssigned = document.getElementById('search-meter-input-assigned');
    const meterListAssigned = document.getElementById('meter-list-assigned');
    const meterItemsAssigned = meterListAssigned.querySelectorAll('.meter-item');

    searchMeterInputAssigned.addEventListener('input', function() {
        const searchTermAssigned = searchMeterInputAssigned.value.toLowerCase();

        meterItemsAssigned.forEach(function(item) {
            const meterNumberAssigned = item.textContent.trim().toLowerCase();
            if (meterNumberAssigned.includes(searchTermAssigned)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    });
</script>
<script>
    const searchMeterInput2 = document.getElementById('search-meter-input-2');
    const meterList2 = document.getElementById('meter-list-2');
    const meterItems2 = meterList2.querySelectorAll('.meter-item');

    searchMeterInput2.addEventListener('input', function() {
        const searchTerm2 = searchMeterInput2.value.toLowerCase();

        meterItems2.forEach(function(item) {
            const meterNumber2 = item.textContent.trim().toLowerCase();
            if (meterNumber2.includes(searchTerm2)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    });
</script>

    <script>
function confirmDelete(meterId) {
    if (confirm("Czy chcesz usunąć ten licznik?")) {
        window.location.href = '/remove_meter/' + meterId;
    }
}
</script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const editNotesButton = document.getElementById('edit-notes-button');
        const notesEditField = document.getElementById('notes-edit-field');

        editNotesButton.addEventListener('click', function () {
            if (notesEditField.style.display === 'none') {
                notesEditField.style.display = 'block';
            } else {
                notesEditField.style.display = 'none';
            }
        });
    });
</script>




{% endblock %}
